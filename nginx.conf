# RAFAEL MUNARO ARQUITETURA - CONFIGURAÇÕES DE SEGURANÇA NGINX
# Adicionar ao bloco server no arquivo de configuração

# Rate limiting para proteção contra ataques de força bruta
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=form:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

# Headers de segurança
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), magnetometer=(), gyroscope=(), accelerometer=(), payment=(), usb=(), autoplay=()" always;

# HSTS (REMOVER se não usar HTTPS)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy aprimorado
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.unsplash.com; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content; report-uri /csp-report;" always;

# Configurações de localização específicas
location / {
    # Rate limiting geral
    limit_req zone=general burst=20 nodelay;

    # Proteção contra acesso a arquivos sensíveis
    location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|backup|old)$ {
        deny all;
        return 404;
    }

    # Configurações de cache
    location ~* \.(css|js)$ {
        expires 1M;
        add_header Cache-Control "public, immutable";
    }

    location ~* \.(png|jpg|jpeg|gif|svg|webp|ico|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Proteção contra hotlinking
    location ~* \.(png|jpg|jpeg|gif|svg|webp|ico)$ {
        valid_referers none blocked rafaelmunaroarquitetura.com/ *.rafaelmunaroarquitetura.com/ github.io *.github.io;
        if ($invalid_referer) {
            return 403;
        }
    }
}

# Rate limiting específico para formulários
location /contact {
    limit_req zone=form burst=5 nodelay;
    try_files $uri $uri/ =404;
}

# Proteção para APIs (se houver)
location /api/ {
    limit_req zone=api burst=10 nodelay;

    # Apenas métodos permitidos
    if ($request_method !~ ^(GET|POST|HEAD)$ ) {
        return 405;
    }

    try_files $uri $uri/ =404;
}

# Bloqueio de user agents suspeitos
if ($http_user_agent ~* "(libwww-perl|BBBike|wget|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner|python-requests|Go-http-client|java|okhttp|scrapy|sqlmap)") {
    return 403;
}

# Proteção contra injeção de arquivos
location ~ \.(php|asp|jsp)$ {
    deny all;
    return 404;
}

# Logs de segurança detalhados
access_log /var/log/nginx/security.log main;

# Configuração de error pages
error_page 400 /error/400.html;
error_page 401 /error/401.html;
error_page 403 /error/403.html;
error_page 404 /error/404.html;
error_page 500 /error/500.html;

# Configuração SSL (exemplo)
# listen 443 ssl http2;
# ssl_certificate /path/to/certificate.crt;
# ssl_certificate_key /path/to/private.key;
# ssl_protocols TLSv1.2 TLSv1.3;
# ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
# ssl_prefer_server_ciphers off;

# Configurações de performance
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied expired no-cache no-store private auth;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/xml+rss
    application/json;

# Configuração de buffer
client_max_body_size 10M;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;
client_body_buffer_size 128k;

# Timeouts seguros
client_header_timeout 10;
client_body_timeout 10;
send_timeout 10;

